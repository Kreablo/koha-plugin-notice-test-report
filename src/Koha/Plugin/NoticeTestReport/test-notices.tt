[% USE Categories %]
[% INCLUDE 'doc-head-open.inc' %]
<title>Notice Test Report</title>
[% INCLUDE 'doc-head-close.inc' %]
</head>
<body>
  [% INCLUDE 'intranetstylesheet.inc' %]
  [% INCLUDE 'header.inc' %]
  [% INCLUDE 'cat-search.inc' %]
  [%# INCLUDE 'reports-toolbar.inc' %]
  <div class="row">
    <div class="col-md-2 order-sm-2 order-md-1">
      [% INCLUDE 'reports-menu.inc' %]
    </div>
    <div class="col-md-10 order-md-2 order-sm-1">
      <div id="breadcrumbs"><a href="/cgi-bin/koha/mainpage.pl">Home</a> &rsaquo; <a href="/cgi-bin/koha/plugins/plugins-home.pl">Plugins</a> &rsaquo; Notice Test Report</div>
      [% INCLUDE 'letter_code_selection' %]
      [% FOREACH branch_res IN branch_results %]
      <h1>Branch: [% branch_res.branch %]</h1>
      [% SET code_results = branch_res.result %]
      [% INCLUDE 'letter_codes' %]
      [% END %]
    </div>
</body>
[% INCLUDE 'intranet-bottom.inc' %]

[%########################################################################################## %]

[% BLOCK 'letter_code_selection' %]
<form method="get">
  <input type="hidden" name="class" value="[% class | html %]">
  <input type="hidden" name="method" value="[% method | html %]">
  <label for="code">Letter Code</label>
  <select name="code">
    [% FOREACH code IN letter_codes %]
    <option
      value="[% code | html %]"
      [% IF code == selected_code %]selected[% END %]
    >
      [% code | html %]
    </option>
    [% END %]
  </select>
  <label for="categorycode">Example using borrower from category (if applicative)</label>
  <select name="categorycode">
    <option value="">None</option>
    [% FOREACH cat IN Categories.all.unblessed %]
    <option
      value="[% cat.categorycode | html %]"
      [% IF cat.categorycode == selected_categorycode %]selected[% END %]
    >
      [% cat.description | html %]
    </option>
    [% END %]
  </select>
  <input type="submit" value="Submit">
</form>
[% END %] [%# letter_code_selection %]

[% BLOCK 'letter_codes' %]
<div class="result container">
  [% IF code_results.error %]
  <div class="alert alert-danger">
    [% code_results.error %]
  </div>
  [% END %]
  [% IF code_results.ok %]
  <h1>Letter code: [% code_results.ok.letter_code %]</h1>
  [% FOREACH lang_res IN code_results.ok.result %]
  [% INCLUDE 'language_result' %]
  [% END%]
  [% END %]
</div>
[% END %] [%# letter_codes %]

[% BLOCK 'language_result' %]
<div style="">
  <h2>Language: [% lang_res.lang %]</h2>
  [% FOREACH transport_res IN lang_res.result %]
  [% INCLUDE 'transport_result' %]
  [% END %]
</div>
[% END %] [%# language_result %]

[% BLOCK 'transport_result' %]
[% UNLESS transport_res.transport == 'sms' && sms_send_driver == '' %]
<h3>Transport type: [% transport_res.transport %]</h3>
<div class="container border">
  [% IF transport_res.error %]
  <div class="alert alert-danger">
    [% transport_res.error %]
  </div>
  [% END %]
  [% IF transport_res.result.warning %]
  <div class="alert alert-warning">
    <p>WARNING: [% transport_res.result.warning %]</p>
  </div>
  [% END %]
  [% IF transport_res.result.error %]
    <div class="alert alert-danger">
      <p>[% transport_res.result.error %]</p>
    </div>
  [% END %]
  [% IF transport_res.result.ok && !transport_res.fallback %]
  <div class="container row">
    <div class="col-4">
      <h4>Template</h4>
    </div>
    <div class="col-4">
      <h4>Html</h4>
    </div>
    <div class="col-4">
      <h4>Preview</h4>
    </div>
  </div>
  <div class="container row">
    <div class="col-4 border">
      <pre>
[% transport_res.result.template.content | html %]
      </pre>
    </div>
    <div class="col-4 border">
      <pre class="resulting-letter">
            [% transport_res.result.ok.content | html %]
      </pre>
    </div>
    <div class="col-4 border" style="display: flex; align-items: stretch;" >
      <iframe
        style="width: 100%;"
        srcdoc="[% transport_res.result.wrapped | html %]"
      >
      </iframe>
    </div>
  </div>
  [% END %]
</div>
[% END %]
[% END %] [%# transport_types %]
